<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√¶rvarsel Trondheim - SINTEF</title>

    <!-- Google Fonts - Lato with multiple weights -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- Twemoji for YoDeck emoji support (self-hosted for reliability) -->
    <script src="twemoji.min.js"></script>

    <!-- SINTEF Base Styles (Clean Version) -->
    <link rel="stylesheet" href="sintef-clean.css">

    <!-- Weather App Custom Styles -->
    <link rel="stylesheet" href="weather-app.css?v=28">
</head>
<body>
    <div class="logo">
        <img src="SINTEF_Logo_Sentrert_RGB.jpg" alt="SINTEF" class="logo-img">
    </div>

    <div id="weather-headline" class="loading">Henter v√¶rdata...</div>

    <div class="weather-container">
        <div id="animation" class="animation-layer"></div>
        <div id="info-box">
            <h2 id="info-title">Visste du at...</h2>
            <div id="info-media"></div>
            <div id="info-text" class="loading">Laster informasjon...</div>
        </div>
    </div>
    
    <div class="menu-wrapper">
        <button class="hamburger-menu" aria-label="Toggle menu">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <div class="test-controls">
            <button onclick="testWeather('sun')">‚òÄÔ∏è Sol</button>
            <button onclick="testWeather('cloudy')">‚òÅÔ∏è Overskyet</button>
            <button onclick="testWeather('rain')">üåßÔ∏è Regn</button>
            <button onclick="testWeather('snow')">‚ùÑÔ∏è Sn√∏</button>
            <button onclick="testWeather('wind')">üí® Vind</button>
        </div>
    </div>

    <script>
        const LAT = 63.4305;
        const LON = 10.3951;

        // Calculate wind chill (f√∏les som temperatur)
        function calculateWindChill(tempC, windSpeedMs) {
            const windKmh = windSpeedMs * 3.6;
            // Wind chill formula only applies when temp < 10¬∞C and wind > 4.8 km/h
            if (tempC >= 10 || windKmh < 4.8) {
                return tempC;
            }
            // Canadian wind chill formula
            const wc = 13.12 + 0.6215 * tempC - 11.37 * Math.pow(windKmh, 0.16)
                       + 0.3965 * tempC * Math.pow(windKmh, 0.16);
            return Math.round(wc);
        }

        // Info box variants for each weather type
        const infoBoxVariants = {
            snow: [
                {
                    title: 'Snow for the Future',
                    text: 'Utvikler klimavennlig, energieffektiv og temperaturuavhengig sn√∏produksjon med varmepumper, sn√∏lagring og gjenbruk, samt deler kunnskap gjennom Sn√∏kompetanse.no.'
                },
                {
                    title: 'Brrrr! N√• er det kaldt ute. ‚ùÑÔ∏è',
                    text: 'SINTEF forsker p√• milj√∏vennlige vedovner.<br><br>Les hvordan du kan fyre varmt og hyggelig i peisen med f√¶rre utslipp p√• SINTEF-bloggen: <a href="http://blogg.sintef.no/tag/energitips/">blogg.sintef.no/tag/energitips/</a>.'
                }
            ],
            rain: [
                {
                    title: 'Verdens beste vannkraftmodeller',
                    text: 'SINTEF sine modeller brukes av kraftprodusenter i hele Norden. Modellene optimaliserer magasinforvaltning, markedsdeltakelse og kraftproduksjon fra langsiktig planlegging til sanntidsdrift.'
                },
                {
                    title: 'N√• h√∏ljer det ned! üåßÔ∏è',
                    text: 'Det er godt nytt for vannmagasinene.<br><br>SINTEF bidrar med milliarder i verdier fra vannkraft.'
                },
                {
                    title: 'N√• er det d√•rlig v√¶r! üåßÔ∏è',
                    text: 'Da hender det at folk mister str√∏mmen.<br><br>SINTEF forsker p√• metoder som gj√∏r at str√∏mmen kommer tilbake s√• raskt som mulig.',
                    media: {
                        type: 'youtube',
                        src: 'iXcNiZAaiGg'
                    }
                }
            ],
            wind: [
                {
                    title: 'Konkurransedyktig norsk havvind og b√¶rekraftig vindkraft',
                    text: `NorthWind er et forskningssenter for vindkraft. Senteret ledes av SINTEF, og skal bidra til l√∏nnsom norsk eksportindustri innen havvind, nye gr√∏nne jobber, og vindkraft som respekterer natur og mennesker.
                    <div class="northwind-footer">
                        <img src="NorthWind.svg" alt="NorthWind" class="northwind-logo-bottom">
                        <span class="northwind-url">northwindresearch.no</span>
                    </div>`,
                    hasLogo: true
                },
                {
                    title: 'Det bl√•ser i dag! üí®',
                    text: 'Det er godt nytt for vindkraften.<br><br>SINTEF forsker p√• hvordan vi kan hindre at fugler kolliderer med vindturbiner.'
                },
                {
                    title: 'Vind i dag! üí®',
                    text: 'Det er bra for fornybar energi.<br><br>SINTEF og NTNU forsker p√• fremtidens str√∏mnett for havvind i prosjektet <strong>OceanGrid</strong>.'
                }
            ],
            sun: [
                {
                    title: 'Solceller p√• taket',
                    text: 'Energibygget har solceller p√• taket og varmepumper for oppvarming og nedkj√∏ling. Bygget kan benytte fjernvarme fra NTNUs fjernvarmering og har milj√∏sertifiseringen BREEAM-NOR Excellent.',
                    media: {
                        type: 'image',
                        src: 'energibygg-solceller.JPG'
                    }
                },
                {
                    title: 'N√• skinner sola! ‚òÄÔ∏è',
                    text: 'Da frister det kanskje med litt aircondition?<br><br>SINTEF og NTNU har i flere ti√•r forsket p√• b√¶rekraftige kj√∏lemetoder som kan bidra til √• hindre ytterligere global oppvarming.'
                }
            ],
            cloudy: [
                {
                    title: 'Solceller virker ogs√• i overskyet v√¶r',
                    text: 'De produserer str√∏m i diffust lys, ofte rundt 10‚Äì40% av klarv√¶rsniv√•. Kaldt v√¶r kan √∏ke virkningsgrad, men sn√∏ som dekker panelene stopper produksjonen.'
                }
            ]
        };

        // Helper function to get random info box variant
        function getRandomInfoBox(type) {
            const variants = infoBoxVariants[type];
            return variants[Math.floor(Math.random() * variants.length)];
        }

        // Helper function to render media (image or video)
        function renderMedia(mediaConfig) {
            const mediaContainer = document.getElementById('info-media');
            if (!mediaConfig) {
                mediaContainer.innerHTML = '';
                return;
            }

            if (mediaConfig.type === 'youtube') {
                mediaContainer.innerHTML = `
                    <iframe
                        src="https://www.youtube.com/embed/${mediaConfig.src}?autoplay=1&mute=1&loop=1&controls=0&modestbranding=1&playsinline=1&playlist=${mediaConfig.src}"
                        frameborder="0"
                        allow="autoplay; encrypted-media"
                        allowfullscreen
                        class="info-media-youtube">
                    </iframe>
                `;
            } else if (mediaConfig.type === 'image') {
                mediaContainer.innerHTML = `
                    <img src="${mediaConfig.src}" alt="" class="info-media-image">
                `;
            }
        }

        // Helper function to parse emoji with Twemoji
        function parseEmoji() {
            if (typeof twemoji !== 'undefined') {
                // Parse emoji in animation layer (snowflakes, clouds, leaves)
                twemoji.parse(document.getElementById('animation'), {
                    folder: 'svg',
                    ext: '.svg'
                });
                // Parse emoji in info box (titles and text)
                twemoji.parse(document.getElementById('info-box'), {
                    folder: 'svg',
                    ext: '.svg'
                });
                // Parse emoji in weather headline
                twemoji.parse(document.getElementById('weather-headline'), {
                    folder: 'svg',
                    ext: '.svg'
                });
            }
        }

        async function fetchWeather() {
            try {
                const url = `https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${LAT}&lon=${LON}`;
                const response = await fetch(url);
                const data = await response.json();
                
                let output = '';
                const timeseries = data.properties.timeseries;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let temps = [];
                let winds = [];
                let precip = 0;
                let clouds = [];
                
                for (let i = 0; i < timeseries.length; i++) {
                    const entry = timeseries[i];
                    const time = new Date(entry.time);
                    const checkDate = new Date(time);
                    checkDate.setHours(0, 0, 0, 0);
                    
                    if (checkDate.getTime() !== today.getTime()) continue;
                    
                    const instant = entry.data.instant.details;
                    temps.push(instant.air_temperature);
                    winds.push(instant.wind_speed);
                    if (instant.cloud_area_fraction !== undefined) {
                        clouds.push(instant.cloud_area_fraction);
                    }
                    
                    const next = entry.data.next_1_hours || entry.data.next_6_hours;
                    if (next?.details.precipitation_amount !== undefined) {
                        precip += next.details.precipitation_amount;
                    }
                }
                
                if (temps.length > 0 && timeseries.length > 0) {
                    // Calculate today's min/max temperatures
                    const minTemp = Math.round(Math.min(...temps));
                    const maxTemp = Math.round(Math.max(...temps));

                    // Get current conditions (first entry in timeseries)
                    const now = timeseries[0].data.instant.details;
                    const currentTemp = Math.round(now.air_temperature);
                    const currentWind = now.wind_speed;

                    // Calculate averages for animation logic
                    const avgTemp = (temps.reduce((a, b) => a + b, 0) / temps.length);
                    const avgCloud = clouds.length > 0 ? (clouds.reduce((a, b) => a + b, 0) / clouds.length) : 0;

                    // LINE 1: Min/Max temperature
                    const line1 = `Laveste meldte i dag er <strong>${minTemp}¬∞</strong> og h√∏yeste meldte er <strong>${maxTemp}¬∞</strong> üå°Ô∏è`;

                    // LINE 2: Current conditions with "feels like"
                    const feelsLike = calculateWindChill(currentTemp, currentWind);
                    let windText;
                    if (currentWind < 2) windText = "svak vind";
                    else if (currentWind < 5) windText = "lett vind";
                    else if (currentWind < 10) windText = "frisk vind";
                    else windText = "sterk vind";

                    const line2 = `Akkurat n√• er det <strong>${windText}</strong> og f√∏les som <strong>${feelsLike}¬∞</strong> üí®`;

                    // LINE 3: Precipitation forecast (next hour)
                    const nextHourPrecip = timeseries[0].data.next_1_hours?.details?.precipitation_amount || 0;
                    let line3;
                    if (nextHourPrecip < 0.1) {
                        line3 = "Ingen nedb√∏r neste time üåßÔ∏è";
                    } else if (nextHourPrecip < 0.5) {
                        line3 = "Lett nedb√∏r neste time üåßÔ∏è";
                    } else if (nextHourPrecip < 2) {
                        line3 = "Moderat nedb√∏r neste time üåßÔ∏è";
                    } else {
                        line3 = `Kraftig nedb√∏r neste time (<strong>${nextHourPrecip.toFixed(1)} mm</strong>) üåßÔ∏è`;
                    }

                    // LINE 4: Cloud forecast (rest of day)
                    const symbolCode = timeseries[0].data.next_6_hours?.summary?.symbol_code ||
                                       timeseries[0].data.next_1_hours?.summary?.symbol_code || '';
                    let line4;
                    if (symbolCode.includes('clearsky') || symbolCode.includes('fair')) {
                        line4 = "Det blir klart resten av dagen ‚òÄÔ∏è";
                    } else if (symbolCode.includes('partlycloudy')) {
                        line4 = "Det blir delvis skyet resten av dagen üå§Ô∏è";
                    } else if (symbolCode.includes('cloudy')) {
                        line4 = "Det forblir overskyet resten av dagen ‚òÅÔ∏è";
                    } else if (symbolCode.includes('rain') || symbolCode.includes('sleet') || symbolCode.includes('snow')) {
                        line4 = "Nedb√∏r ventet senere i dag üåßÔ∏è";
                    } else {
                        // Fallback: use average cloud coverage
                        if (avgCloud < 25) line4 = "Det blir klart resten av dagen ‚òÄÔ∏è";
                        else if (avgCloud < 50) line4 = "Det blir lettskyet resten av dagen üå§Ô∏è";
                        else if (avgCloud < 75) line4 = "Det blir delvis skyet resten av dagen üå•Ô∏è";
                        else line4 = "Det forblir overskyet resten av dagen ‚òÅÔ∏è";
                    }

                    // Combine all lines with proper HTML structure
                    output = `
                        <div class="temp-range">${line1}</div>
                        <div class="current-conditions">${line2}</div>
                        <div class="precipitation-forecast">${line3}</div>
                        <div class="cloud-forecast">${line4}</div>
                    `;

                    // Show animation based on current conditions
                    showWeatherAnimation(currentTemp, currentWind, nextHourPrecip, avgCloud);
                }

                const headline = document.getElementById('weather-headline');
                headline.innerHTML = output;

                // Trigger animation
                headline.classList.remove('animate-in');
                void headline.offsetWidth; // Force reflow
                headline.classList.add('animate-in');

            } catch (error) {
                document.getElementById('weather-headline').textContent = 'Kunne ikke hente v√¶rdata';
            }
        }

        function showWeatherAnimation(temp, wind, precip, cloud) {
            const animationDiv = document.getElementById('animation');
            animationDiv.innerHTML = '';
            const infoText = document.getElementById('info-text');
            const infoBox = document.getElementById('info-box');

            // Trigger info box animation
            infoBox.classList.remove('animate-in');
            void infoBox.offsetWidth; // Force reflow
            infoBox.classList.add('animate-in');

            // Prioriter animasjoner
            if (precip > 1 && temp < 2) {
                // SN√ò
                document.body.classList.remove('dark-bg');
                animationDiv.className = 'animation-layer snow-animation';
                for (let i = 0; i < 50; i++) {
                    const snowflake = document.createElement('div');
                    snowflake.className = 'snowflake';
                    snowflake.textContent = '‚ùÑ';
                    snowflake.style.left = Math.random() * 100 + '%';
                    snowflake.style.animationDuration = (Math.random() * 3 + 3) + 's';
                    snowflake.style.animationDelay = -(Math.random() * 6) + 's';
                    snowflake.style.opacity = Math.random() * 0.6 + 0.4;
                    animationDiv.appendChild(snowflake);
                }
                const snowInfo = getRandomInfoBox('snow');
                document.getElementById('info-title').textContent = snowInfo.title;
                renderMedia(snowInfo.media);
                infoText.innerHTML = snowInfo.text;
                parseEmoji();
            } else if (precip > 0.5) {
                // REGN
                document.body.classList.add('dark-bg');
                animationDiv.className = 'animation-layer rain-animation';
                for (let i = 0; i < 100; i++) {
                    const rain = document.createElement('div');
                    rain.className = 'rain';
                    rain.style.left = Math.random() * 100 + '%';
                    rain.style.animationDuration = (Math.random() * 0.5 + 0.5) + 's';
                    rain.style.animationDelay = -(Math.random() * 2) + 's';
                    animationDiv.appendChild(rain);
                }
                const rainInfo = getRandomInfoBox('rain');
                document.getElementById('info-title').textContent = rainInfo.title;
                renderMedia(rainInfo.media);
                infoText.innerHTML = rainInfo.text;
                parseEmoji();
            } else if (wind > 5) {
                // VIND
                document.body.classList.add('dark-bg');
                animationDiv.className = 'animation-layer wind-animation';

                // Legg til l√∏v som bl√•ser forbi
                const leafEmojis = ['üçÇ', 'üçÉ', 'üçÅ'];
                for (let i = 0; i < 15; i++) {
                    const leaf = document.createElement('div');
                    leaf.className = 'leaf';
                    leaf.textContent = leafEmojis[Math.floor(Math.random() * leafEmojis.length)];
                    leaf.style.top = Math.random() * 80 + 10 + '%';
                    leaf.style.animationDuration = (Math.random() * 3 + 3) + 's';
                    leaf.style.animationDelay = Math.random() * 5 + 's';
                    animationDiv.appendChild(leaf);
                }

                // Get random wind info variant
                const windInfo = getRandomInfoBox('wind');

                // Set info box content
                document.getElementById('info-title').textContent = windInfo.title;
                renderMedia(windInfo.media);
                infoText.innerHTML = windInfo.text;
                parseEmoji();
            } else if (cloud > 70) {
                // OVERSKYET
                document.body.classList.add('dark-bg');
                animationDiv.className = 'animation-layer cloudy-animation';
                for (let i = 0; i < 8; i++) {
                    const cloudEl = document.createElement('div');
                    cloudEl.className = 'cloud';
                    cloudEl.textContent = '‚òÅÔ∏è';
                    cloudEl.style.top = (Math.random() * 60 + 10) + '%';
                    cloudEl.style.animationDuration = (Math.random() * 30 + 20) + 's';
                    cloudEl.style.animationDelay = -(Math.random() * 50) + 's';
                    animationDiv.appendChild(cloudEl);
                }
                const cloudyInfo = getRandomInfoBox('cloudy');
                document.getElementById('info-title').textContent = cloudyInfo.title;
                renderMedia(cloudyInfo.media);
                infoText.innerHTML = cloudyInfo.text;
                parseEmoji();
            } else {
                // SOL (default)
                document.body.classList.add('dark-bg');
                animationDiv.className = 'animation-layer sun-animation';
                const sun = document.createElement('div');
                sun.className = 'sun';
                animationDiv.appendChild(sun);

                // Legg til noen skyer for variasjon
                for (let i = 0; i < 3; i++) {
                    const cloudEl = document.createElement('div');
                    cloudEl.style.position = 'absolute';
                    cloudEl.style.fontSize = '60px';
                    cloudEl.style.top = (Math.random() * 30 + 10) + '%';
                    cloudEl.style.left = (Math.random() * -20) + '%';
                    cloudEl.textContent = '‚òÅÔ∏è';
                    cloudEl.style.animation = `drift ${Math.random() * 40 + 40}s linear infinite`;
                    cloudEl.style.opacity = '0.4';
                    animationDiv.appendChild(cloudEl);
                }
                const sunInfo = getRandomInfoBox('sun');
                document.getElementById('info-title').textContent = sunInfo.title;
                renderMedia(sunInfo.media);
                infoText.innerHTML = sunInfo.text;
                parseEmoji();
            }
        }

        fetchWeather();
        
        // Test-funksjon for √• simulere forskjellig v√¶r
        function testWeather(type) {
            // Fjern active class fra alle knapper
            document.querySelectorAll('.test-controls button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Legg til active class p√• klikket knapp
            const buttons = document.querySelectorAll('.test-controls button');
            const typeMap = { 'sun': 0, 'cloudy': 1, 'rain': 2, 'snow': 3, 'wind': 4 };
            buttons[typeMap[type]].classList.add('active');

            // Define test conditions
            const conditions = {
                'sun': { minTemp: 15, maxTemp: 20, currentTemp: 17, wind: 2.5, precip: 0, cloud: 20 },
                'cloudy': { minTemp: 10, maxTemp: 15, currentTemp: 12, wind: 1.5, precip: 0, cloud: 85 },
                'rain': { minTemp: 8, maxTemp: 12, currentTemp: 10, wind: 3.2, precip: 4.5, cloud: 90 },
                'snow': { minTemp: -2, maxTemp: 1, currentTemp: -0.5, wind: 2.8, precip: 3.2, cloud: 95 },
                'wind': { minTemp: 5, maxTemp: 10, currentTemp: 7.5, wind: 12.5, precip: 0, cloud: 60 }
            };

            const cond = conditions[type];

            // LINE 1: Min/Max
            const line1 = `Laveste meldte i dag er <strong>${cond.minTemp}¬∞</strong> og h√∏yeste meldte er <strong>${cond.maxTemp}¬∞</strong> üå°Ô∏è`;

            // LINE 2: Current + feels like
            const feelsLike = calculateWindChill(cond.currentTemp, cond.wind);
            let windText;
            if (cond.wind < 2) windText = "svak vind";
            else if (cond.wind < 5) windText = "lett vind";
            else if (cond.wind < 10) windText = "frisk vind";
            else windText = "sterk vind";
            const line2 = `Akkurat n√• er det <strong>${windText}</strong> og f√∏les som <strong>${feelsLike}¬∞</strong> üí®`;

            // LINE 3: Precipitation
            let line3;
            if (cond.precip < 0.1) {
                line3 = "Ingen nedb√∏r neste time üåßÔ∏è";
            } else if (cond.precip < 0.5) {
                line3 = "Lett nedb√∏r neste time üåßÔ∏è";
            } else if (cond.precip < 2) {
                line3 = "Moderat nedb√∏r neste time üåßÔ∏è";
            } else {
                line3 = `Kraftig nedb√∏r neste time (<strong>${cond.precip.toFixed(1)} mm</strong>) üåßÔ∏è`;
            }

            // LINE 4: Cloud forecast
            let line4;
            if (cond.cloud < 25) line4 = "Det blir klart resten av dagen ‚òÄÔ∏è";
            else if (cond.cloud < 50) line4 = "Det blir lettskyet resten av dagen üå§Ô∏è";
            else if (cond.cloud < 75) line4 = "Det blir delvis skyet resten av dagen üå•Ô∏è";
            else line4 = "Det forblir overskyet resten av dagen ‚òÅÔ∏è";

            // Build HTML
            const headline = document.getElementById('weather-headline');
            headline.innerHTML = `
                <div class="temp-range">${line1}</div>
                <div class="current-conditions">${line2}</div>
                <div class="precipitation-forecast">${line3}</div>
                <div class="cloud-forecast">${line4}</div>
            `;

            // Trigger animation
            headline.classList.remove('animate-in');
            void headline.offsetWidth; // Force reflow
            headline.classList.add('animate-in');

            // Show animation
            showWeatherAnimation(cond.currentTemp, cond.wind, cond.precip, cond.cloud);
        }
    </script>
</body>
</html>