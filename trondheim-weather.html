<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Værvarsel Trondheim - SINTEF</title>

    <!-- Google Fonts - JetBrains Mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Weather Display Styles -->
    <link rel="stylesheet" href="weather-display.css">
</head>
<body>
    <div class="logo">
        <svg class="logo-svg" aria-label="SINTEF" viewBox="0 0 177.14 193.29" fill="none">
            <path d="M135.71,45.29c0,20.4-9.19,45.14-46.94,45.14s-46.94-24.74-46.94-45.14S51.01,.16,88.77,.16s46.94,24.74,46.94,45.13m-50,37.61c1,0,2,.06,3.05,.06,33.6,0,41.77-22,41.77-40.17S123.15,4.79,93.59,2.79l-1.79,4.91c-1,0-2-.06-3-.06-33.61,0-41.78,22-41.78,40.17s7.38,38,36.95,40l1.74-4.91Z" fill="#fff"></path>
            <path d="M124.44,45.29c0,15.1-7,33.41-35.67,33.41s-35.68-18.31-35.68-33.41S60.09,11.89,88.77,11.89s35.67,18.31,35.67,33.4m-36.89-25.91c-22.77,.52-28.36,15.79-28.36,28.42s5.69,28.17,29,28.43l1.83-5c22.77-.52,28.36-15.79,28.36-28.42s-5.69-28.17-29-28.43l-1.83,5Z" fill="#fff"></path>
            <path d="M91.79,66.23l2.95-8.12c2.4-6.59,1.06-10.93-6-12.81s-8.38-6.23-6-12.82l2.95-8.12c1-.07,2-.11,3-.11,18.5,0,23,11.54,23,21s-4,19.73-20,20.93" fill="#fff"></path>
            <path d="M32.02,124.66c-4.93-1.7-7.86-2.35-10.75-2.35s-5.24,1.11-5.24,2.42c0,4,17.09,3.12,17.09,12.31,0,5.05-5,7.46-12.6,7.46-4.21,.07-8.39-.79-12.23-2.54v-5.68c4.87,2.51,7.86,3.4,11.59,3.4,3.23,0,5.15-1.5,5.15-3.05,0-4.32-17-2.74-17-12.2,0-4.55,4.63-6.95,12.49-6.95,3.92,.03,7.81,.72,11.5,2.05v5.13Z" fill="#fff"></path>
            <rect x="39.47" y="117.83" width="7.14" height="26.33" fill="#fff"></rect>
            <polygon points="61.39 144.16 53.99 144.16 53.99 117.83 60.78 117.83 76.78 134.28 76.78 117.83 83.93 117.83 83.93 144.16 77.95 144.16 61.39 126.85 61.39 144.16" fill="#fff"></polygon>
            <polygon points="141.88 144.16 119.16 144.16 119.16 117.83 141.91 117.83 141.91 122.39 126.21 122.39 126.21 128.26 140.35 128.26 140.35 132.91 126.21 132.91 126.21 139.5 141.88 139.5 141.88 144.16" fill="#fff"></polygon>
            <polygon points="169.47 122.39 153.58 122.39 153.58 128.61 167.79 128.61 167.79 133.26 153.58 133.26 153.58 144.16 146.53 144.16 146.53 117.83 169.47 117.83 169.47 122.39" fill="#fff"></polygon>
            <polygon points="105.11 144.16 105.11 122.48 115.55 122.48 115.55 117.83 87.48 117.83 87.48 122.48 98 122.48 98 144.16 105.11 144.16" fill="#fff"></polygon>
            <path d="M74.2,171.66v1.56c0,.44-.05,.8-.14,1.07-.1,.27-.19,.5-.28,.7l-6.11,12.94c-.16,.34-.4,.63-.71,.87-.31,.24-.72,.35-1.24,.35h-2.71l6.24-12.52c.17-.34,.35-.65,.55-.92,.2-.27,.41-.53,.64-.78h-7.69c-.11,0-.22-.02-.32-.07s-.19-.1-.26-.18c-.08-.08-.14-.16-.19-.26-.05-.1-.07-.2-.07-.31v-2.45h12.29Z" fill="#ffedb8"></path>
            <path d="M86.82,173.2c0,.26-.04,.49-.12,.7s-.21,.39-.38,.55c-.17,.16-.4,.28-.68,.36-.28,.08-.62,.13-1.01,.13h-4.18l-.49,2.89c.33-.06,.64-.1,.95-.13,.3-.03,.6-.04,.89-.04,.92,0,1.73,.14,2.44,.42,.7,.28,1.3,.66,1.78,1.15,.48,.48,.84,1.05,1.09,1.7,.24,.65,.37,1.35,.37,2.09,0,.94-.17,1.79-.5,2.56-.33,.77-.79,1.44-1.39,2-.59,.56-1.3,.99-2.12,1.3-.82,.31-1.72,.46-2.69,.46-.57,0-1.11-.06-1.63-.18-.52-.12-1-.28-1.45-.49-.45-.2-.87-.44-1.25-.71-.38-.27-.73-.55-1.04-.86l1.15-1.54c.12-.16,.26-.28,.42-.37s.33-.13,.52-.13c.24,0,.47,.07,.68,.2s.44,.28,.7,.43c.25,.16,.55,.3,.88,.43s.75,.19,1.25,.19,.92-.08,1.27-.25c.35-.16,.64-.39,.86-.67,.22-.28,.38-.62,.48-1,.1-.38,.15-.79,.15-1.22,0-.85-.24-1.49-.72-1.94-.48-.44-1.16-.67-2.04-.67-.78,0-1.55,.15-2.3,.44l-2.3-.62,1.49-8.75h8.95v1.54Z" fill="#ffedb8"></path>
            <path d="M104.63,189.15h-1.33c-.28,0-.5-.04-.66-.13s-.28-.25-.36-.51l-.26-.88c-.31,.28-.62,.53-.92,.74-.3,.21-.61,.39-.93,.53-.32,.14-.66,.25-1.02,.32-.36,.07-.76,.11-1.2,.11-.52,0-1-.07-1.44-.21-.44-.14-.82-.35-1.13-.63-.32-.28-.56-.63-.74-1.05s-.26-.9-.26-1.46c0-.47,.12-.92,.37-1.38,.24-.45,.65-.86,1.22-1.23,.57-.37,1.32-.67,2.27-.91,.94-.24,2.12-.36,3.52-.36v-.73c0-.83-.17-1.44-.52-1.84s-.85-.6-1.52-.6c-.48,0-.88,.06-1.2,.17-.32,.11-.6,.24-.83,.38-.24,.14-.45,.27-.65,.38-.2,.11-.42,.17-.66,.17-.2,0-.37-.05-.52-.16-.14-.1-.26-.23-.35-.38l-.54-.95c1.42-1.3,3.12-1.94,5.12-1.94,.72,0,1.36,.12,1.93,.35,.56,.24,1.04,.56,1.44,.98,.39,.42,.69,.92,.89,1.51,.21,.58,.31,1.22,.31,1.92v7.78Zm-5.76-1.85c.3,0,.58-.03,.84-.08,.26-.05,.5-.14,.73-.25,.23-.11,.45-.25,.66-.41,.21-.16,.43-.35,.64-.57v-2.06c-.86,0-1.59,.05-2.17,.16-.58,.11-1.05,.25-1.4,.42-.35,.17-.6,.37-.75,.59-.15,.23-.22,.47-.22,.74,0,.52,.15,.9,.46,1.12,.31,.23,.71,.34,1.21,.34Zm-1.58-14.05c0-.37,.07-.7,.22-1.01,.14-.3,.34-.56,.58-.78,.24-.22,.53-.38,.85-.5,.32-.12,.66-.18,1.01-.18s.7,.06,1.03,.18c.33,.12,.62,.29,.86,.5,.25,.22,.45,.48,.6,.78,.15,.3,.22,.64,.22,1.01s-.07,.69-.22,.98c-.15,.3-.35,.55-.6,.76s-.54,.38-.86,.49-.67,.17-1.03,.17-.69-.06-1.01-.17-.6-.28-.85-.49-.44-.47-.58-.76c-.14-.3-.22-.62-.22-.98Zm1.61,0c0,.3,.09,.56,.28,.76,.19,.2,.46,.31,.81,.31,.32,0,.58-.1,.77-.31,.19-.2,.29-.46,.29-.76,0-.34-.1-.6-.29-.8-.19-.2-.45-.29-.77-.29-.35,0-.62,.1-.81,.29-.19,.2-.28,.46-.28,.8Z" fill="#ffedb8"></path>
            <path d="M107.54,189.15v-12.31h1.74c.3,0,.52,.06,.64,.17,.12,.11,.2,.3,.24,.58l.18,1.49c.44-.76,.96-1.36,1.55-1.8s1.26-.66,1.99-.66c.61,0,1.11,.14,1.51,.42l-.38,2.22c-.02,.14-.08,.25-.16,.31-.08,.06-.19,.09-.32,.09-.12,0-.28-.03-.49-.08s-.48-.08-.83-.08c-.62,0-1.14,.17-1.58,.51-.44,.34-.81,.84-1.12,1.49v7.67h-2.96Z" fill="#ffedb8"></path>
            <line x1=".01" y1="182.11" x2="57.18" y2="182.11" fill="none" stroke="#ffedb8" stroke-miterlimit="10" stroke-width="2"></line>
            <line x1="120.15" y1="182.11" x2="177.05" y2="182.11" fill="none" stroke="#ffedb8" stroke-miterlimit="10" stroke-width="2"></line>
        </svg>
    </div>

    <div class="location-tag green">
        <span>Været i Sem Sælands vei</span>
    </div>

    <div id="weather-headline">Henter værdata...</div>

    <div class="weather-container">
        <div id="weather-animation" class="weather-animation"></div>
    </div>


    <footer>
        <div class="footer-content">
            <span class="data-source">Værdata fra MET.no</span>
            <span id="last-updated" class="last-updated"></span>
            <span class="version-info">v1.1</span>
        </div>
    </footer>

    <script>
        // Sem Sælands vei, Trondheim (63°24'59.6"N 10°24'17.0"E)
        const LAT = 63.4165556;
        const LON = 10.4047222;

        // Terminal typing animation
        function typeWriter(element, text, baseSpeed, callback) {
            let i = 0;
            element.innerHTML = '';

            const cursor = document.createElement('span');
            cursor.className = 'terminal-cursor';
            element.appendChild(cursor);

            function getRandomDelay() {
                // More varied human-like typing
                const random = Math.random();
                if (random < 0.6) {
                    // 60% of the time: very fast typing (10-30ms)
                    return 10 + Math.random() * 20;
                } else if (random < 0.85) {
                    // 25% of the time: fast typing (30-60ms)
                    return 30 + Math.random() * 30;
                } else if (random < 0.95) {
                    // 10% of the time: normal typing (60-100ms)
                    return 60 + Math.random() * 40;
                } else {
                    // 5% of the time: brief pause (100-150ms)
                    return 100 + Math.random() * 50;
                }
            }

            function type() {
                if (i < text.length) {
                    const char = text.charAt(i);
                    const textNode = document.createTextNode(char);
                    element.insertBefore(textNode, cursor);
                    i++;

                    // Add extra delay after punctuation
                    let delay = getRandomDelay();
                    if (char === ',' || char === '.') {
                        delay += 50 + Math.random() * 100;
                    }

                    setTimeout(type, delay);
                } else {
                    setTimeout(() => {
                        cursor.remove();
                        if (callback) callback();
                    }, 200);
                }
            }

            type();
        }

        function animateWeatherHeadline(line1, line2, line3, line4, onComplete) {
            const headline = document.getElementById('weather-headline');
            headline.innerHTML = `
                <div class="temp-range"></div>
                <div class="current-conditions"></div>
                <div class="precipitation-forecast"></div>
                <div class="cloud-forecast"></div>
            `;

            const lines = [
                { element: headline.querySelector('.temp-range'), text: line1 },
                { element: headline.querySelector('.current-conditions'), text: line2 },
                { element: headline.querySelector('.precipitation-forecast'), text: line3 },
                { element: headline.querySelector('.cloud-forecast'), text: line4 }
            ];

            let currentLine = 0;

            function animateNextLine() {
                if (currentLine < lines.length) {
                    const line = lines[currentLine];
                    // Strip HTML tags for typing, we'll add them back
                    const plainText = line.text.replace(/<[^>]*>/g, '');
                    line.element.innerHTML = line.text; // Set full HTML first
                    const fullHTML = line.element.innerHTML;

                    // Now animate just the text
                    typeWriter(line.element, plainText, 30, () => {
                        // Restore HTML formatting after typing
                        line.element.innerHTML = fullHTML;
                        currentLine++;
                        setTimeout(animateNextLine, 300);
                    });
                } else if (onComplete) {
                    // All lines done, call completion callback
                    onComplete();
                }
            }

            animateNextLine();
        }

        // Calculate wind chill (føles som temperatur)
        function calculateWindChill(tempC, windSpeedMs) {
            const windKmh = windSpeedMs * 3.6;
            // Wind chill formula only applies when temp < 10°C and wind > 4.8 km/h
            if (tempC >= 10 || windKmh < 4.8) {
                return tempC;
            }
            // Canadian wind chill formula
            const wc = 13.12 + 0.6215 * tempC - 11.37 * Math.pow(windKmh, 0.16)
                       + 0.3965 * tempC * Math.pow(windKmh, 0.16);
            return Math.round(wc);
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            const lastUpdatedEl = document.getElementById('last-updated');
            lastUpdatedEl.textContent = `Sist oppdatert: ${hours}:${minutes}`;
        }

        async function fetchWeather() {
            try {
                const url = `https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${LAT}&lon=${LON}`;
                const response = await fetch(url);
                const data = await response.json();
                
                let output = '';
                const timeseries = data.properties.timeseries;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let temps = [];
                let winds = [];
                let precip = 0;
                let clouds = [];
                
                for (let i = 0; i < timeseries.length; i++) {
                    const entry = timeseries[i];
                    const time = new Date(entry.time);
                    const checkDate = new Date(time);
                    checkDate.setHours(0, 0, 0, 0);
                    
                    if (checkDate.getTime() !== today.getTime()) continue;
                    
                    const instant = entry.data.instant.details;
                    temps.push(instant.air_temperature);
                    winds.push(instant.wind_speed);
                    if (instant.cloud_area_fraction !== undefined) {
                        clouds.push(instant.cloud_area_fraction);
                    }
                    
                    const next = entry.data.next_1_hours || entry.data.next_6_hours;
                    if (next?.details.precipitation_amount !== undefined) {
                        precip += next.details.precipitation_amount;
                    }
                }
                
                if (temps.length > 0 && timeseries.length > 0) {
                    // Calculate today's min/max temperatures
                    const minTemp = Math.round(Math.min(...temps));
                    const maxTemp = Math.round(Math.max(...temps));

                    // Get current conditions (first entry in timeseries)
                    const now = timeseries[0].data.instant.details;
                    const currentTemp = Math.round(now.air_temperature);
                    const currentWind = now.wind_speed;

                    // Calculate averages for animation logic
                    const avgTemp = (temps.reduce((a, b) => a + b, 0) / temps.length);
                    const avgCloud = clouds.length > 0 ? (clouds.reduce((a, b) => a + b, 0) / clouds.length) : 0;

                    // LINE 1: Min/Max temperature
                    const line1 = `<strong>Laveste meldte i dag er ${minTemp}° og høyeste meldte er ${maxTemp}°</strong>`;

                    // LINE 2: Current conditions with "feels like"
                    const feelsLike = calculateWindChill(currentTemp, currentWind);
                    let windText;
                    if (currentWind < 2) windText = "svak vind";
                    else if (currentWind < 5) windText = "lett vind";
                    else if (currentWind < 10) windText = "frisk vind";
                    else windText = "sterk vind";

                    const line2 = `Akkurat nå er det ${windText} og føles som ${feelsLike}°`;

                    // LINE 3: Precipitation forecast (next hour)
                    const nextHourPrecip = timeseries[0].data.next_1_hours?.details?.precipitation_amount || 0;
                    const precipProb = timeseries[0].data.next_1_hours?.details?.probability_of_precipitation;
                    const isSnow = currentTemp < 2; // Snow if temp below 2°C
                    const precipWord = isSnow ? "snø" : "nedbør";
                    const precipIcon = isSnow ? "snowflake" : "cloud-rain";

                    let line3;
                    if (nextHourPrecip < 0.1) {
                        line3 = `Ingen ${precipWord} neste time`;
                    } else {
                        const probText = precipProb ? `${Math.round(precipProb)}% sjanse for ` : '';
                        if (nextHourPrecip < 0.5) {
                            line3 = `${probText}lett ${precipWord} neste time`;
                        } else if (nextHourPrecip < 2) {
                            line3 = `${probText}moderat ${precipWord} neste time`;
                        } else {
                            line3 = `${probText}kraftig ${precipWord} neste time (${nextHourPrecip.toFixed(1)} mm)`;
                        }
                    }

                    // LINE 4: Cloud forecast (rest of day)
                    const symbolCode = timeseries[0].data.next_6_hours?.summary?.symbol_code ||
                                       timeseries[0].data.next_1_hours?.summary?.symbol_code || '';
                    let line4;
                    if (symbolCode.includes('clearsky') || symbolCode.includes('fair')) {
                        line4 = "Klarvær resten av dagen";
                    } else if (symbolCode.includes('partlycloudy')) {
                        line4 = "Delvis skyet resten av dagen";
                    } else if (symbolCode.includes('cloudy')) {
                        line4 = "Overskyet resten av dagen";
                    } else if (symbolCode.includes('rain') || symbolCode.includes('sleet') || symbolCode.includes('snow')) {
                        line4 = "Nedbør ventet senere i dag";
                    } else {
                        // Fallback: use average cloud coverage
                        if (avgCloud < 25) line4 = "Klarvær resten av dagen";
                        else if (avgCloud < 50) line4 = "Lettskyet resten av dagen";
                        else if (avgCloud < 75) line4 = "Delvis skyet resten av dagen";
                        else line4 = "Overskyet resten av dagen";
                    }

                    // Determine weather conditions for animations
                    const isSnowCondition = currentTemp < 2 && nextHourPrecip > 0.1;
                    const isRainCondition = currentTemp >= 2 && nextHourPrecip > 0.5;
                    const isCloudyCondition = avgCloud > 70;
                    const isSunnyCondition = avgCloud < 30;

                    // Start weather animation
                    startWeatherAnimation(isSnowCondition, isRainCondition, isCloudyCondition, isSunnyCondition);

                    // Update last updated timestamp
                    updateLastUpdated();

                    // Animate weather headline with terminal typing
                    animateWeatherHeadline(line1, line2, line3, line4);
                }

            } catch (error) {
                document.getElementById('weather-headline').textContent = 'Kunne ikke hente værdata';
            }
        }

        // Start weather animation based on conditions
        function startWeatherAnimation(isSnow, isRain, isCloudy, isSunny) {
            const container = document.getElementById('weather-animation');
            container.innerHTML = ''; // Clear previous animation

            if (isSnow) {
                // Create subtle snow animation
                for (let i = 0; i < 30; i++) {
                    const flake = document.createElement('div');
                    flake.className = 'snow-flake';
                    flake.textContent = '❄';
                    flake.style.left = Math.random() * 100 + '%';
                    flake.style.animationDuration = (Math.random() * 3 + 4) + 's';
                    flake.style.animationDelay = -(Math.random() * 5) + 's';
                    flake.style.fontSize = (Math.random() * 0.5 + 1) + 'rem';
                    container.appendChild(flake);
                }
            } else if (isRain) {
                // Create subtle rain animation
                for (let i = 0; i < 50; i++) {
                    const drop = document.createElement('div');
                    drop.className = 'rain-drop';
                    drop.style.left = Math.random() * 100 + '%';
                    drop.style.animationDuration = (Math.random() * 0.3 + 0.5) + 's';
                    drop.style.animationDelay = -(Math.random() * 2) + 's';
                    container.appendChild(drop);
                }
            } else if (isCloudy) {
                // Create subtle cloud animation
                for (let i = 0; i < 3; i++) {
                    const cloud = document.createElement('div');
                    cloud.className = 'cloud';
                    cloud.textContent = '☁';
                    cloud.style.top = (Math.random() * 30 + 10) + '%';
                    cloud.style.animationDuration = (Math.random() * 20 + 30) + 's';
                    cloud.style.animationDelay = -(Math.random() * 30) + 's';
                    container.appendChild(cloud);
                }
            }
            // No animation for sunny - keep it clean
        }

        fetchWeather();

        // Refresh weather data every 5 minutes
        setInterval(() => {
            fetchWeather();
        }, 5 * 60 * 1000);
    </script>
</body>
</html>